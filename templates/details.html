{% extends "base.html" %}

{% block title %}{{ home_team.name }} vs {{ away_team.name }} - Details{% endblock %}

{% block extra_css %}
<style>
    .team-view {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .team-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f4f8;
    }
    
    /* Team Comparison Cards */
    .team-comparison {
        display: flex;
        gap: 32px;
        margin-bottom: 30px;
        justify-content: center;
    }
    
    .team-card {
        border: 1px solid #ddd;
        border-radius: 12px;
        background: #fafcfe;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        padding: 25px;
        min-width: 320px;
        text-align: center;
        flex: 1;
        max-width: 400px;
    }
    
    .team-card h4 {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.4rem;
        font-weight: bold;
        border-bottom: 2px solid #667eea;
        padding-bottom: 10px;
    }
    
    .team-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        font-size: 1rem;
        margin-bottom: 25px;
    }
    
    .stat-item {
        padding: 12px;
        background: white;
        border-radius: 8px;
        border: 1px solid #e9ecef;
        transition: transform 0.2s ease;
    }
    
    .stat-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .stat-label {
        font-weight: bold;
        color: #667eea;
        font-size: 0.9rem;
        margin-bottom: 4px;
    }
    
    .stat-value {
        font-size: 1.3rem;
        color: #333;
        font-weight: bold;
    }
    
    /* Stats Controls */
    .stats-controls {
        display: flex;
        gap: 4px;
        margin-bottom: 25px;
        justify-content: center;
    }
    
    .tab-btn {
        padding: 12px 24px;
        border: 2px solid #667eea;
        background: white;
        color: #667eea;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-weight: 600;
        font-size: 1rem;
    }
    
    .tab-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .tab-btn.active-tab {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    /* Roster Tables */
    .roster-section {
        margin-bottom: 40px;
    }
    
    .section-title {
        font-size: 1.6rem;
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 3px solid #667eea;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .roster-columns {
        display: flex;
        gap: 40px;
        align-items: flex-start;
    }
    
    .team-column {
        flex: 1;
        min-width: 400px;
    }
    
    .team-column h4 {
        color: white;
        margin-bottom: 15px;
        font-size: 1.3rem;
        text-align: center;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 8px;
        font-weight: bold;
    }
    
    .stats-table {
        width: 100%;
        border-collapse: collapse;
        background: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 25px;
    }
    
    .stats-table th {
        background: #667eea;
        color: white;
        padding: 12px 8px;
        text-align: center;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .stats-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #dee2e6;
        font-size: 0.9rem;
        text-align: center;
        transition: background-color 0.2s ease;
    }
    
    .stats-table tr:hover {
        background: #e9ecef;
    }
    
    .player-name {
        font-weight: 600;
        color: #333;
        text-align: left !important;
    }
    
    .position {
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.8rem;
        color: #666;
    }
    
    .favorite-control {
        text-align: center;
    }
    
    .favorite-checkbox {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 1rem;
        background: #f8f9fa;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }
    
    .favorite-checkbox input[type="checkbox"] {
        transform: scale(1.2);
    }
    
    .stat-good {
        background-color: #d4edda !important;
        color: #155724;
        font-weight: bold;
    }
    
    .stat-bad {
        background-color: #f8d7da !important;
        color: #721c24;
        font-weight: bold;
    }
    
    .loading-message {
        text-align: center;
        color: #666;
        font-style: italic;
        padding: 20px;
    }
    
    /* Loading spinner */
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 8px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Mobile Styles */
    @media (max-width: 768px) {
        .team-view {
            padding: 10px !important;
        }
        
        .team-comparison {
            flex-direction: column !important;
            gap: 15px !important;
        }
        
        .team-card {
            min-width: auto !important;
            padding: 15px !important;
        }
        
        .team-stats {
            grid-template-columns: 1fr 1fr !important;
            gap: 8px !important;
        }
        
        .stat-item {
            padding: 8px !important;
        }
        
        .stat-value {
            font-size: 1.1rem !important;
        }
        
        .roster-columns {
            flex-direction: column !important;
            gap: 20px !important;
        }
        
        /* Mobile Table Optimization */
        .stats-table {
            font-size: 0.65rem !important;
            width: 100% !important;
            display: block !important;
            overflow-x: auto !important;
            white-space: nowrap !important;
            -webkit-overflow-scrolling: touch !important;
        }
        
        .stats-table thead,
        .stats-table tbody,
        .stats-table tr {
            display: table !important;
            width: 100% !important;
        }
        
        .stats-table th,
        .stats-table td {
            padding: 3px 2px !important;
            font-size: 0.65rem !important;
            text-align: center !important;
            border-right: 1px solid #ddd !important;
        }
        
        /* Column Widths for Mobile */
        .stats-table th:nth-child(1),
        .stats-table td:nth-child(1) {
            width: 100px !important;
            min-width: 100px !important;
            max-width: 100px !important;
            text-align: left !important;
            position: sticky !important;
            left: 0 !important;
            background: #f8f9fa !important;
            z-index: 2 !important;
            font-size: 0.6rem !important;
        }
        
        .stats-table th:nth-child(2),
        .stats-table td:nth-child(2) {
            width: 35px !important;
            min-width: 35px !important;
        }
        
        .stats-table th:nth-child(3),
        .stats-table td:nth-child(3),
        .stats-table th:nth-child(4),
        .stats-table td:nth-child(4),
        .stats-table th:nth-child(5),
        .stats-table td:nth-child(5) {
            width: 45px !important;
            min-width: 45px !important;
        }
        
        .stats-table th:nth-child(6),
        .stats-table td:nth-child(6),
        .stats-table th:nth-child(7),
        .stats-table td:nth-child(7),
        .stats-table th:nth-child(8),
        .stats-table td:nth-child(8),
        .stats-table th:nth-child(9),
        .stats-table td:nth-child(9) {
            width: 35px !important;
            min-width: 35px !important;
        }
        
        /* Tab Controls */
        .stats-controls {
            flex-wrap: wrap !important;
            gap: 6px !important;
            justify-content: center !important;
        }
        
        .tab-btn {
            padding: 8px 12px !important;
            font-size: 0.85rem !important;
            flex: 1 !important;
            min-width: 80px !important;
        }
        
        /* Section Headers */
        .section-title {
            font-size: 1.3rem !important;
        }
        
        .team-column h4 {
            font-size: 1.1rem !important;
            padding: 10px !important;
        }
        
        /* Better conditional formatting visibility on mobile */
        .stat-good {
            background-color: #c3e6cb !important;
            color: #155724 !important;
            font-weight: bold !important;
        }
        
        .stat-bad {
            background-color: #f5c6cb !important;
            color: #721c24 !important;
            font-weight: bold !important;
        }
    }

    /* Landscape mobile optimization */
    @media (max-width: 768px) and (orientation: landscape) {
        .stats-table {
            font-size: 0.7rem !important;
        }
        
        .stats-table th,
        .stats-table td {
            padding: 4px 3px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="team-view">
    <div class="team-header">
        <h2>{{ away_team.name }} @ {{ home_team.name }}</h2>
        <a href="{{ url_for('home') }}" class="back-btn">‚Üê Back to Games</a>
    </div>
    
    <!-- Stats Period Controls -->
    <div class="stats-controls">
        <button class="tab-btn active-tab" id="tab-7" data-days="7">7 Days</button>
        <button class="tab-btn" id="tab-10" data-days="10">10 Days</button>
        <button class="tab-btn" id="tab-21" data-days="21">21 Days</button>
    </div>
    
    <!-- Team Comparison Section -->
    <div class="roster-section">
        <h3 class="section-title">‚ö° Team Comparison (2025 Season Stats)</h3>
        
        <!-- 7 Days Team Comparison -->
        <div class="team-comparison stat-window stat-7">
            <div class="team-card">
                <h4>{{ away_team.name }}</h4>
                <div class="team-stats">
                    <div class="stat-item">
                        <div class="stat-label">Team AVG</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('7', {}).get('AVG', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Team OBP</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('7', {}).get('OBP', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Team SLG</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('7', {}).get('SLG', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Home Runs</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('7', {}).get('HR', '0') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg Hits</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('7', {}).get('AVG_HITS', '0.0') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg K</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('7', {}).get('AVG_K', '0.0') }}</div>
                    </div>
                </div>
                <div class="favorite-control">
                    <form method="post" action="{{ url_for('toggle_favorite') }}">
                        <label class="favorite-checkbox">
                            <input type="checkbox" name="favorite" value="{{ away_team.name }}"
                                {% if away_team.name in favorites %}checked{% endif %}
                                onchange="this.form.submit()">
                            ‚≠ê Favorite this team
                        </label>
                    </form>
                </div>
            </div>
            
            <div class="team-card">
                <h4>{{ home_team.name }}</h4>
                <div class="team-stats">
                    <div class="stat-item">
                        <div class="stat-label">Team AVG</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('7', {}).get('AVG', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Team OBP</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('7', {}).get('OBP', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Team SLG</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('7', {}).get('SLG', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Home Runs</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('7', {}).get('HR', '0') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg Hits</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('7', {}).get('AVG_HITS', '0.0') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg K</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('7', {}).get('AVG_K', '0.0') }}</div>
                    </div>
                </div>
                <div class="favorite-control">
                    <form method="post" action="{{ url_for('toggle_favorite') }}">
                        <label class="favorite-checkbox">
                            <input type="checkbox" name="favorite" value="{{ home_team.name }}"
                                {% if home_team.name in favorites %}checked{% endif %}
                                onchange="this.form.submit()">
                            ‚≠ê Favorite this team
                        </label>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 10 Days Team Comparison -->
        <div class="team-comparison stat-window stat-10" style="display:none">
            <div class="team-card">
                <h4>{{ away_team.name }}</h4>
                <div class="team-stats">
                    <div class="stat-item">
                        <div class="stat-label">Team AVG</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('10', {}).get('AVG', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Team OBP</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('10', {}).get('OBP', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Team SLG</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('10', {}).get('SLG', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Home Runs</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('10', {}).get('HR', '0') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg Hits</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('10', {}).get('AVG_HITS', '0.0') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg K</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('10', {}).get('AVG_K', '0.0') }}</div>
                    </div>
                </div>
                <div class="favorite-control">
                    <form method="post" action="{{ url_for('toggle_favorite') }}">
                        <label class="favorite-checkbox">
                            <input type="checkbox" name="favorite" value="{{ away_team.name }}"
                                {% if away_team.name in favorites %}checked{% endif %}
                                onchange="this.form.submit()">
                            ‚≠ê Favorite this team
                        </label>
                    </form>
                </div>
            </div>
            
            <div class="team-card">
                <h4>{{ home_team.name }}</h4>
                <div class="team-stats">
                    <div class="stat-item">
                        <div class="stat-label">Team AVG</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('10', {}).get('AVG', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Team OBP</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('10', {}).get('OBP', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Team SLG</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('10', {}).get('SLG', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Home Runs</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('10', {}).get('HR', '0') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg Hits</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('10', {}).get('AVG_HITS', '0.0') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg K</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('10', {}).get('AVG_K', '0.0') }}</div>
                    </div>
                </div>
                <div class="favorite-control">
                    <form method="post" action="{{ url_for('toggle_favorite') }}">
                        <label class="favorite-checkbox">
                            <input type="checkbox" name="favorite" value="{{ home_team.name }}"
                                {% if home_team.name in favorites %}checked{% endif %}
                                onchange="this.form.submit()">
                            ‚≠ê Favorite this team
                        </label>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- 21 Days Team Comparison -->
        <div class="team-comparison stat-window stat-21" style="display:none">
            <div class="team-card">
                <h4>{{ away_team.name }}</h4>
                <div class="team-stats">
                    <div class="stat-item">
                        <div class="stat-label">Team AVG</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('21', {}).get('AVG', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Team OBP</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('21', {}).get('OBP', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Team SLG</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('21', {}).get('SLG', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Home Runs</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('21', {}).get('HR', '0') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg Hits</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('21', {}).get('AVG_HITS', '0.0') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg K</div>
                        <div class="stat-value">{{ away_team.rollingTeamStats.get('21', {}).get('AVG_K', '0.0') }}</div>
                    </div>
                </div>
                <div class="favorite-control">
                    <form method="post" action="{{ url_for('toggle_favorite') }}">
                        <label class="favorite-checkbox">
                            <input type="checkbox" name="favorite" value="{{ away_team.name }}"
                                {% if away_team.name in favorites %}checked{% endif %}
                                onchange="this.form.submit()">
                            ‚≠ê Favorite this team
                        </label>
                    </form>
                </div>
            </div>
            
            <div class="team-card">
                <h4>{{ home_team.name }}</h4>
                <div class="team-stats">
                    <div class="stat-item">
                        <div class="stat-label">Team AVG</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('21', {}).get('AVG', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Team OBP</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('21', {}).get('OBP', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Team SLG</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('21', {}).get('SLG', '.000') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Home Runs</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('21', {}).get('HR', '0') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg Hits</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('21', {}).get('AVG_HITS', '0.0') }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg K</div>
                        <div class="stat-value">{{ home_team.rollingTeamStats.get('21', {}).get('AVG_K', '0.0') }}</div>
                    </div>
                </div>
                <div class="favorite-control">
                    <form method="post" action="{{ url_for('toggle_favorite') }}">
                        <label class="favorite-checkbox">
                            <input type="checkbox" name="favorite" value="{{ home_team.name }}"
                                {% if home_team.name in favorites %}checked{% endif %}
                                onchange="this.form.submit()">
                            ‚≠ê Favorite this team
                        </label>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Complete Rosters -->
    <div class="roster-section">
        <h3 class="section-title">üë• Team Rosters (2025 Season Stats)</h3>
        <div class="roster-columns">
            <div class="team-column">
                <h4>{{ away_team.name }} Batters</h4>
                
                <!-- Away Team Batters - 7 Days -->
                <table class="stats-table stat-window stat-7">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Pos</th>
                            <th>AVG</th>
                            <th>SLG</th>
                            <th>OBP</th>
                            <th>HR</th>
                            <th>RBI</th>
                            <th>H</th>
                            <th>AB</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if away_team.fullRoster.batters %}
                            {% for batter in away_team.fullRoster.batters[:15] %}
                            <tr>
                                <td class="player-name">{{ batter.name }}</td>
                                <td><span class="position">{{ batter.position }}</span></td>
                                {% set avg_val = batter.get('stats', {}).get('7', {}).get('avg', '.000')|float %}
                                <td {% if avg_val > 0.265 %}class="stat-good"{% elif avg_val < 0.240 and avg_val > 0 %}class="stat-bad"{% endif %}>{{ "%.3f"|format(avg_val) }}</td>
                                {% set slg_val = batter.get('stats', {}).get('7', {}).get('slg', '.000')|float %}
                                <td {% if slg_val > 0.450 %}class="stat-good"{% endif %}>{{ "%.3f"|format(slg_val) }}</td>
                                {% set obp_val = batter.get('stats', {}).get('7', {}).get('obp', '.000')|float %}
                                <td {% if obp_val > 0.400 %}class="stat-good"{% endif %}>{{ "%.3f"|format(obp_val) }}</td>
                                <td>{{ batter.get('stats', {}).get('7', {}).get('hr', '0') }}</td>
                                <td>{{ batter.get('stats', {}).get('7', {}).get('rbi', '0') }}</td>
                                <td>{{ batter.get('stats', {}).get('7', {}).get('h', '0') }}</td>
                                <td>{{ batter.get('stats', {}).get('7', {}).get('ab', '0') }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="9" class="loading-message">Loading player data...</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
                
                <!-- Away Team Batters - 10 Days -->
                <table class="stats-table stat-window stat-10" style="display:none">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Pos</th>
                            <th>AVG</th>
                            <th>SLG</th>
                            <th>OBP</th>
                            <th>HR</th>
                            <th>RBI</th>
                            <th>H</th>
                            <th>AB</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if away_team.fullRoster.batters %}
                            {% for batter in away_team.fullRoster.batters[:15] %}
                            <tr>
                                <td class="player-name">{{ batter.name }}</td>
                                <td><span class="position">{{ batter.position }}</span></td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="9" class="loading-message">Loading player data...</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
                
                <!-- Away Team Batters - 21 Days -->
                <table class="stats-table stat-window stat-21" style="display:none">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Pos</th>
                            <th>AVG</th>
                            <th>SLG</th>
                            <th>OBP</th>
                            <th>HR</th>
                            <th>RBI</th>
                            <th>H</th>
                            <th>AB</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if away_team.fullRoster.batters %}
                            {% for batter in away_team.fullRoster.batters[:15] %}
                            <tr>
                                <td class="player-name">{{ batter.name }}</td>
                                <td><span class="position">{{ batter.position }}</span></td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="9" class="loading-message">Loading player data...</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
                
                <!-- Away Team Pitchers Section -->
                <h4 style="margin-top: 25px;">{{ away_team.name }} Pitchers</h4>
                
                <!-- Away Team Pitchers - 7 Days -->
                <table class="stats-table stat-window stat-7">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>ERA</th>
                            <th>WHIP</th>
                            <th>K</th>
                            <th>BB</th>
                            <th>IP</th>
                            <th>GS</th>
                            <th>SV</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if away_team.fullRoster.pitchers %}
                            {% for pitcher in away_team.fullRoster.pitchers[:15] %}
                            <tr>
                                <td class="player-name">{{ pitcher.name }}</td>
                                {% set era_val = pitcher.get('stats', {}).get('7', {}).get('era', '0.00')|float %}
                                <td {% if era_val < 3.00 and era_val > 0 %}class="stat-good"{% elif era_val > 5.00 %}class="stat-bad"{% endif %}>{{ pitcher.get('stats', {}).get('7', {}).get('era', '0.00') }}</td>
                                {% set whip_val = pitcher.get('stats', {}).get('7', {}).get('whip', '0.00')|float %}
                                <td {% if whip_val < 1.20 and whip_val > 0 %}class="stat-good"{% elif whip_val > 1.50 %}class="stat-bad"{% endif %}>{{ pitcher.get('stats', {}).get('7', {}).get('whip', '0.00') }}</td>
                                <td>{{ pitcher.get('stats', {}).get('7', {}).get('k', '0') }}</td>
                                <td>{{ pitcher.get('stats', {}).get('7', {}).get('bb', '0') }}</td>
                                <td>{{ pitcher.get('stats', {}).get('7', {}).get('ip', '0.0') }}</td>
                                <td>{{ pitcher.get('stats', {}).get('7', {}).get('gs', '0') }}</td>
                                <td>{{ pitcher.get('stats', {}).get('7', {}).get('sv', '0') }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="8" class="loading-message">Loading player data...</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
                
                <!-- Away Team Pitchers - 10 Days -->
                <table class="stats-table stat-window stat-10" style="display:none">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>ERA</th>
                            <th>WHIP</th>
                            <th>K</th>
                            <th>BB</th>
                            <th>IP</th>
                            <th>GS</th>
                            <th>SV</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if away_team.fullRoster.pitchers %}
                            {% for pitcher in away_team.fullRoster.pitchers[:15] %}
                            <tr>
                                <td class="player-name">{{ pitcher.name }}</td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="8" class="loading-message">Loading player data...</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
                
                <!-- Away Team Pitchers - 21 Days -->
                <table class="stats-table stat-window stat-21" style="display:none">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>ERA</th>
                            <th>WHIP</th>
                            <th>K</th>
                            <th>BB</th>
                            <th>IP</th>
                            <th>GS</th>
                            <th>SV</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if away_team.fullRoster.pitchers %}
                            {% for pitcher in away_team.fullRoster.pitchers[:15] %}
                            <tr>
                                <td class="player-name">{{ pitcher.name }}</td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="8" class="loading-message">Loading player data...</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            <!-- HOME TEAM COLUMN -->
            <div class="team-column">
                <h4>{{ home_team.name }} Batters</h4>
                
                <!-- Home Team Batters - 7 Days -->
                <table class="stats-table stat-window stat-7">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Pos</th>
                            <th>AVG</th>
                            <th>SLG</th>
                            <th>OBP</th>
                            <th>HR</th>
                            <th>RBI</th>
                            <th>H</th>
                            <th>AB</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if home_team.fullRoster.batters %}
                            {% for batter in home_team.fullRoster.batters[:15] %}
                            <tr>
                                <td class="player-name">{{ batter.name }}</td>
                                <td><span class="position">{{ batter.position }}</span></td>
                                {% set avg_val = batter.get('stats', {}).get('7', {}).get('avg', '.000')|float %}
                                <td {% if avg_val > 0.265 %}class="stat-good"{% elif avg_val < 0.240 and avg_val > 0 %}class="stat-bad"{% endif %}>{{ "%.3f"|format(avg_val) }}</td>
                                {% set slg_val = batter.get('stats', {}).get('7', {}).get('slg', '.000')|float %}
                                <td {% if slg_val > 0.450 %}class="stat-good"{% endif %}>{{ "%.3f"|format(slg_val) }}</td>
                                {% set obp_val = batter.get('stats', {}).get('7', {}).get('obp', '.000')|float %}
                                <td {% if obp_val > 0.400 %}class="stat-good"{% endif %}>{{ "%.3f"|format(obp_val) }}</td>
                                <td>{{ batter.get('stats', {}).get('7', {}).get('hr', '0') }}</td>
                                <td>{{ batter.get('stats', {}).get('7', {}).get('rbi', '0') }}</td>
                                <td>{{ batter.get('stats', {}).get('7', {}).get('h', '0') }}</td>
                                <td>{{ batter.get('stats', {}).get('7', {}).get('ab', '0') }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="9" class="loading-message">Loading player data...</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
                
                <!-- Home Team Batters - 10 Days -->
                <table class="stats-table stat-window stat-10" style="display:none">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Pos</th>
                            <th>AVG</th>
                            <th>SLG</th>
                            <th>OBP</th>
                            <th>HR</th>
                            <th>RBI</th>
                            <th>H</th>
                            <th>AB</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if home_team.fullRoster.batters %}
                            {% for batter in home_team.fullRoster.batters[:15] %}
                            <tr>
                                <td class="player-name">{{ batter.name }}</td>
                                <td><span class="position">{{ batter.position }}</span></td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="9" class="loading-message">Loading player data...</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
                
                <!-- Home Team Batters - 21 Days -->
                <table class="stats-table stat-window stat-21" style="display:none">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>Pos</th>
                            <th>AVG</th>
                            <th>SLG</th>
                            <th>OBP</th>
                            <th>HR</th>
                            <th>RBI</th>
                            <th>H</th>
                            <th>AB</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if home_team.fullRoster.batters %}
                            {% for batter in home_team.fullRoster.batters[:15] %}
                            <tr>
                                <td class="player-name">{{ batter.name }}</td>
                                <td><span class="position">{{ batter.position }}</span></td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="9" class="loading-message">Loading player data...</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
                
                <!-- Home Team Pitchers Section -->
                <h4 style="margin-top: 25px;">{{ home_team.name }} Pitchers</h4>
                
                <!-- Home Team Pitchers - 7 Days -->
                <table class="stats-table stat-window stat-7">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>ERA</th>
                            <th>WHIP</th>
                            <th>K</th>
                            <th>BB</th>
                            <th>IP</th>
                            <th>GS</th>
                            <th>SV</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if home_team.fullRoster.pitchers %}
                            {% for pitcher in home_team.fullRoster.pitchers[:15] %}
                            <tr>
                                <td class="player-name">{{ pitcher.name }}</td>
                                {% set era_val = pitcher.get('stats', {}).get('7', {}).get('era', '0.00')|float %}
                                <td {% if era_val < 3.00 and era_val > 0 %}class="stat-good"{% elif era_val > 5.00 %}class="stat-bad"{% endif %}>{{ pitcher.get('stats', {}).get('7', {}).get('era', '0.00') }}</td>
                                {% set whip_val = pitcher.get('stats', {}).get('7', {}).get('whip', '0.00')|float %}
                                <td {% if whip_val < 1.20 and whip_val > 0 %}class="stat-good"{% elif whip_val > 1.50 %}class="stat-bad"{% endif %}>{{ pitcher.get('stats', {}).get('7', {}).get('whip', '0.00') }}</td>
                                <td>{{ pitcher.get('stats', {}).get('7', {}).get('k', '0') }}</td>
                                <td>{{ pitcher.get('stats', {}).get('7', {}).get('bb', '0') }}</td>
                                <td>{{ pitcher.get('stats', {}).get('7', {}).get('ip', '0.0') }}</td>
                                <td>{{ pitcher.get('stats', {}).get('7', {}).get('gs', '0') }}</td>
                                <td>{{ pitcher.get('stats', {}).get('7', {}).get('sv', '0') }}</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="8" class="loading-message">Loading player data...</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
                
                <!-- Home Team Pitchers - 10 Days -->
                <table class="stats-table stat-window stat-10" style="display:none">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>ERA</th>
                            <th>WHIP</th>
                            <th>K</th>
                            <th>BB</th>
                            <th>IP</th>
                            <th>GS</th>
                            <th>SV</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if home_team.fullRoster.pitchers %}
                            {% for pitcher in home_team.fullRoster.pitchers[:15] %}
                            <tr>
                                <td class="player-name">{{ pitcher.name }}</td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="8" class="loading-message">Loading player data...</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
                
                <!-- Home Team Pitchers - 21 Days -->
                <table class="stats-table stat-window stat-21" style="display:none">
                    <thead>
                        <tr>
                            <th>Player</th>
                            <th>ERA</th>
                            <th>WHIP</th>
                            <th>K</th>
                            <th>BB</th>
                            <th>IP</th>
                            <th>GS</th>
                            <th>SV</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if home_team.fullRoster.pitchers %}
                            {% for pitcher in home_team.fullRoster.pitchers[:15] %}
                            <tr>
                                <td class="player-name">{{ pitcher.name }}</td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">Loading...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                                <td class="loading-message">...</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="8" class="loading-message">Loading player data...</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Improved JavaScript with team IDs from backend
let loadedPeriods = ['7']; // Track which periods are loaded
const currentMatchup = {
    homeId: {{ home_team.get('id', 0) }},  // Get team ID safely
    awayId: {{ away_team.get('id', 0) }}
};

// Loading state management
let isLoading = false;

async function setStatWindow(days) {
    if (isLoading) return; // Prevent multiple simultaneous requests
    
    isLoading = true;
    
    // Show loading indicator
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.disabled = true;
        if (btn.id === `tab-${days}`) {
            btn.innerHTML = '<span class="loading-spinner"></span>Loading...';
        }
    });
    
    try {
        // If stats not loaded for this period, load them
        if (!loadedPeriods.includes(days)) {
            await loadStatsForPeriod(days);
        }
        
        // Hide all windows, deactivate all tabs
        ['7','10','21'].forEach(function(day){
            document.querySelectorAll('.stat-'+day).forEach(function(el){
                el.style.display = 'none';
            });
            const tabBtn = document.getElementById('tab-'+day);
            if (tabBtn) {
                tabBtn.classList.remove('active-tab');
                tabBtn.disabled = false;
                tabBtn.innerHTML = day + ' Days';
            }
        });
        
        // Show selected, activate tab
        document.querySelectorAll('.stat-'+days).forEach(function(el){
            el.style.display = '';
        });
        const activeTab = document.getElementById('tab-'+days);
        if (activeTab) {
            activeTab.classList.add('active-tab');
        }
        
    } catch (error) {
        console.error('Failed to load stats:', error);
        showErrorMessage('Failed to load stats. Please try again.');
    } finally {
        isLoading = false;
        
        // Restore button states
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.disabled = false;
            if (!btn.classList.contains('active-tab')) {
                const dayMatch = btn.id.match(/tab-(\d+)/);
                if (dayMatch) {
                    btn.innerHTML = dayMatch[1] + ' Days';
                }
            }
        });
    }
}

async function loadStatsForPeriod(days) {
    try {
        const response = await fetch(`/api/load-stats/${currentMatchup.homeId}/${currentMatchup.awayId}/${days}`, {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }
        
        // Update tables with new data
        updateTablesWithStats(data, days);
        loadedPeriods.push(days);
        
        console.log(`Successfully loaded ${days}-day stats`);
        
    } catch (error) {
        console.error(`Error loading ${days}-day stats:`, error);
        throw error;
    }
}

function updateTablesWithStats(data, days) {
    try {
        // Update away team batters
        updatePlayerTable(data.away_batters, days, 'away', 'batter');
        
        // Update home team batters  
        updatePlayerTable(data.home_batters, days, 'home', 'batter');
        
        // Update away team pitchers
        updatePlayerTable(data.away_pitchers, days, 'away', 'pitcher');
        
        // Update home team pitchers
        updatePlayerTable(data.home_pitchers, days, 'home', 'pitcher');
        
        console.log(`Updated all tables for ${days}-day period`);
        
    } catch (error) {
        console.error('Error updating tables:', error);
    }
}

function updatePlayerTable(players, days, team, playerType) {
    try {
        // Find the appropriate table
        const tableSelector = `.stat-${days} table`;
        const tables = document.querySelectorAll(tableSelector);
        
        if (!tables.length) {
            console.warn(`No tables found for period ${days}`);
            return;
        }
        
        // Find the correct table based on team and player type
        let targetTable = null;
        
        tables.forEach(table => {
            const container = table.closest('.team-column');
            if (!container) return;
            
            const header = container.querySelector('h4');
            if (!header) return;
            
            const headerText = header.textContent.toLowerCase();
            const teamName = team === 'away' ? '{{ away_team.name|lower }}' : '{{ home_team.name|lower }}';
            const isCorrectTeam = headerText.includes(teamName.toLowerCase());
            const isCorrectType = (playerType === 'batter' && headerText.includes('batters')) ||
                                 (playerType === 'pitcher' && headerText.includes('pitchers'));
            
            if (isCorrectTeam && isCorrectType) {
                targetTable = table;
            }
        });
        
        if (!targetTable) {
            console.warn(`Target table not found for ${team} ${playerType}s, ${days} days`);
            return;
        }
        
        const tbody = targetTable.querySelector('tbody');
        if (!tbody) return;
        
        // Update each row
        players.forEach((player, index) => {
            const row = tbody.children[index];
            if (!row) return;
            
            const stats = player.stats[days];
            if (!stats) return;
            
            // Update cells based on player type
            if (playerType === 'batter') {
                updateBatterRow(row, stats);
            } else {
                updatePitcherRow(row, stats);
            }
        });
        
    } catch (error) {
        console.error(`Error updating ${team} ${playerType} table:`, error);
    }
}

function updateBatterRow(row, stats) {
    try {
        const cells = row.children;
        if (cells.length < 9) return;
        
        // Skip player name (0) and position (1)
        // Update AVG (2), SLG (3), OBP (4), HR (5), RBI (6), H (7), AB (8)
        
        // AVG with conditional formatting
        const avgVal = parseFloat(stats.avg || 0);
        cells[2].textContent = stats.avg || '.000';
        cells[2].className = '';
        if (avgVal > 0.265) {
            cells[2].classList.add('stat-good');
        } else if (avgVal < 0.240 && avgVal > 0) {
            cells[2].classList.add('stat-bad');
        }
        
        // SLG
        const slgVal = parseFloat(stats.slg || 0);
        cells[3].textContent = stats.slg || '.000';
        cells[3].className = '';
        if (slgVal > 0.450) {
            cells[3].classList.add('stat-good');
        }
        
        // OBP
        const obpVal = parseFloat(stats.obp || 0);
        cells[4].textContent = stats.obp || '.000';
        cells[4].className = '';
        if (obpVal > 0.400) {
            cells[4].classList.add('stat-good');
        }
        
        // Other stats
        cells[5].textContent = stats.hr || '0';
        cells[6].textContent = stats.rbi || '0';
        cells[7].textContent = stats.h || '0';
        cells[8].textContent = stats.ab || '0';
        
    } catch (error) {
        console.error('Error updating batter row:', error);
    }
}

function updatePitcherRow(row, stats) {
    try {
        const cells = row.children;
        if (cells.length < 8) return;
        
        // Skip player name (0)
        // Update ERA (1), WHIP (2), K (3), BB (4), IP (5), GS (6), SV (7)
        
        // ERA with conditional formatting
        const eraVal = parseFloat(stats.era || 0);
        cells[1].textContent = stats.era || '0.00';
        cells[1].className = '';
        if (eraVal < 3.00 && eraVal > 0) {
            cells[1].classList.add('stat-good');
        } else if (eraVal > 5.00) {
            cells[1].classList.add('stat-bad');
        }
        
        // WHIP with conditional formatting
        const whipVal = parseFloat(stats.whip || 0);
        cells[2].textContent = stats.whip || '0.00';
        cells[2].className = '';
        if (whipVal < 1.20 && whipVal > 0) {
            cells[2].classList.add('stat-good');
        } else if (whipVal > 1.50) {
            cells[2].classList.add('stat-bad');
        }
        
        // Other stats
        cells[3].textContent = stats.k || '0';
        cells[4].textContent = stats.bb || '0';
        cells[5].textContent = stats.ip || '0.0';
        cells[6].textContent = stats.gs || '0';
        cells[7].textContent = stats.sv || '0';
        
    } catch (error) {
        console.error('Error updating pitcher row:', error);
    }
}

function showErrorMessage(message) {
    // Create or update error message
    let errorDiv = document.getElementById('error-message');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'error-message';
        errorDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 300px;
            font-size: 14px;
        `;
        document.body.appendChild(errorDiv);
    }
    
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        if (errorDiv && errorDiv.parentNode) {
            errorDiv.style.display = 'none';
        }
    }, 5000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('MLB Stats Tracker loaded');
    console.log('Current matchup:', currentMatchup);
    
    // Verify team IDs are available
    if (!currentMatchup.homeId || !currentMatchup.awayId) {
        console.warn('Team IDs not available - on-demand loading may not work');
    }
    
    // Add click handlers to buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const dayMatch = this.id.match(/tab-(\d+)/);
            if (dayMatch && !isLoading) {
                setStatWindow(dayMatch[1]);
            }
        });
    });
});

// Error handling for network issues
window.addEventListener('online', function() {
    console.log('Connection restored');
});

window.addEventListener('offline', function() {
    console.log('Connection lost');
    showErrorMessage('No internet connection. Some features may not work.');
});
</script>
{% endblock %}